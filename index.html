<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topology Optimization</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Topology <span>Optimization</span></h1>
            <p class="subtitle">Start ‚Üí Import ‚Üí Solution Type ‚Üí Material ‚Üí Manufacturing ‚Üí Solve</p>
            <button id="mobileTogglePanel" class="btn-icon mobile-toggle-btn" title="Minimize Settings">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline id="mobileToggleIcon" points="18 15 12 9 6 15"></polyline>
                </svg>
            </button>
            <button id="mobileToggleViewer" class="btn-icon mobile-viewer-toggle-btn" title="Show 3D Viewer">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                </svg>
            </button>
        </header>

        <div class="workflow">
            <!-- Step 1: Get Started -->
            <div class="step" id="step1" data-step="1">
                <div class="step-header">
                    <span class="step-number">1</span>
                    <h2>Get Started</h2>
                </div>
                <div class="step-content">
                    <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 1rem;">Choose how to begin your topology optimization project.</p>
                    <div class="start-options">
                        <div class="start-option-card" id="startNewProject">
                            <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="12" y1="18" x2="12" y2="12"></line>
                                <line x1="9" y1="15" x2="15" y2="15"></line>
                            </svg>
                            <strong>New Project</strong>
                            <small>Import a 3D model (STL/STEP) or 2D profile (DXF/SVG) or use a template to start a new optimization</small>
                        </div>
                        <div class="start-option-card" id="startImportProject">
                            <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            <strong>Import Project</strong>
                            <small>Load a previously exported setup file (.json) to continue where you left off</small>
                        </div>
                    </div>
                    <input type="file" id="importSetupFile" accept="application/json,.json" class="hidden">
                </div>
            </div>

            <!-- Step 2: Import Model -->
            <div class="step" id="step2" data-step="2" disabled>
                <div class="step-header">
                    <span class="step-number">2</span>
                    <h2>Import Model</h2>
                </div>
                <div class="step-content">
                    <div class="upload-area" id="uploadArea">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <p>Drop STL, STEP, DXF or SVG file here or click to browse</p>
                        <input type="file" id="fileInput" accept=".stl,.stp,.step,.dxf,.svg" hidden>
                    </div>
                    <div class="quick-start">
                        <p>Or start with a template:</p>
                        <button id="useBeamTemplate" class="btn-secondary">Cantilever Beam</button>
                        <button id="useBridgeTemplate" class="btn-secondary">Bridge</button>
                        <button id="useCubeTemplate" class="btn-secondary">Cube Test (3D)</button>
                        <button id="useGasketTemplate" class="btn-secondary">Soft Gasket (2D)</button>
                    </div>
                    <div id="meshMethodSelector" class="mesh-method-selector hidden">
                        <p><strong>Select Meshing Method:</strong></p>
                        <label class="mesh-method-option">
                            <input type="radio" name="meshMethod" value="box" checked>
                            <span class="mesh-method-label">
                                <strong>Box Mesh (Voxelized)</strong>
                                <small>Classic axis-aligned voxel grid. Works with all file types.</small>
                            </span>
                        </label>
                        <label class="mesh-method-option" id="blendedCurvatureOption">
                            <input type="radio" name="meshMethod" value="blended-curvature">
                            <span class="mesh-method-label">
                                <strong>Blended Curvature Mesh</strong>
                                <small>Curvature-adaptive mesh that follows surface geometry. STEP files only.</small>
                            </span>
                        </label>
                        <button id="confirmMeshMethod" class="btn-primary" style="margin-top: 0.75rem;">Continue ‚Üí</button>
                    </div>
                    <div id="dimensionModeSelector" class="mesh-method-selector hidden">
                        <p><strong>Analysis Mode:</strong></p>
                        <label class="mesh-method-option">
                            <input type="radio" name="dimensionMode" value="3d" checked>
                            <span class="mesh-method-label">
                                <strong>3D Analysis</strong>
                                <small>Full three-dimensional mesh and solver.</small>
                            </span>
                        </label>
                        <label class="mesh-method-option">
                            <input type="radio" name="dimensionMode" value="2d">
                            <span class="mesh-method-label">
                                <strong>2D Analysis</strong>
                                <small>Project to a single-depth 2D mesh. Choose projection side below.</small>
                            </span>
                        </label>
                        <div id="projectionSideSelector" class="hidden" style="margin-top: 0.75rem;">
                            <p style="font-size: 0.875rem; margin-bottom: 0.5rem;"><strong>Projection Side:</strong></p>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                <button class="btn-secondary projection-btn" data-side="front" title="Front (XY plane, looking from +Z)">Front (XY)</button>
                                <button class="btn-secondary projection-btn" data-side="back" title="Back (XY plane, looking from -Z)">Back (XY)</button>
                                <button class="btn-secondary projection-btn selected" data-side="top" title="Top (XZ plane, looking from +Y)">Top (XZ)</button>
                                <button class="btn-secondary projection-btn" data-side="bottom" title="Bottom (XZ plane, looking from -Y)">Bottom (XZ)</button>
                                <button class="btn-secondary projection-btn" data-side="right" title="Right (YZ plane, looking from +X)">Right (YZ)</button>
                                <button class="btn-secondary projection-btn" data-side="left" title="Left (YZ plane, looking from -X)">Left (YZ)</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Preview -->
            <div class="step" id="step3" data-step="3" disabled>
                <div class="step-header">
                    <span class="step-number">3</span>
                    <h2>Preview & Solution Type</h2>
                </div>
                <div class="step-content">
                    <div id="modelInfo" class="model-info"></div>
                    <!-- Solution type cards -->
                    <div style="margin-top: 1rem;">
                        <label style="font-weight: 600; font-size: 0.875rem; display: block; margin-bottom: 0.5rem;">What do you want to solve?</label>
                        <div class="solution-type-options">
                            <div class="solution-type-card selected" data-solution="topology">
                                <span class="solution-type-icon">üèó</span>
                                <strong>Topology Optimization</strong>
                                <small>Find the optimal material distribution under loads (SIMP / Genetic)</small>
                            </div>
                            <div class="solution-type-card" data-solution="fea">
                                <span class="solution-type-icon">üìê</span>
                                <strong>Linear FEA</strong>
                                <small>Single-pass stress & displacement analysis (small deformations)</small>
                            </div>
                            <div class="solution-type-card" data-solution="nonlinear">
                                <span class="solution-type-icon">üî©</span>
                                <strong>Nonlinear FEA</strong>
                                <small>Large deformation analysis with Newton-Raphson and incremental loading</small>
                            </div>
                            <div class="solution-type-card" data-solution="fatigue">
                                <span class="solution-type-icon">‚ö°</span>
                                <strong>Fatigue Analysis</strong>
                                <small>Predict fatigue life using S-N curve (W√∂hler) approach</small>
                            </div>
                        </div>
                    </div>
                    <!-- Algorithm selector: shown only for topology optimization -->
                    <div id="topoAlgorithmGroup" class="control-group" style="margin-top: 1rem;">
                        <label>Optimization Algorithm</label>
                        <select id="solverSelect">
                            <option value="auto" selected>Auto (detect from model)</option>
                            <option value="2d">2D SIMP</option>
                            <option value="3d">3D SIMP</option>
                            <option value="mgpcg">3D MGPCG (fastest 3D)</option>
                            <option value="cg">3D Jacobi-CG</option>
                            <option value="petsc-bddc">3D PETSc KSP (BDDC)</option>
                            <option value="petsc-mg">3D PETSc KSP (MG preconditioner)</option>
                            <option value="petsc-jacobi">3D PETSc KSP (Jacobi preconditioner)</option>
                            <option value="genetic">Genetic Algorithm</option>
                        </select>
                        <small style="display: block; color: #666; margin-top: 0.25rem;">Select 2D or 3D solving, or let the app auto-detect from your model.</small>
                    </div>
                    <!-- Linear FEA parameters: shown only for fea -->
                    <div id="feaParamsGroup" class="control-group" style="margin-top: 1rem; display: none;">
                        <label style="font-weight: 600; font-size: 0.875rem; display: block; margin-bottom: 0.5rem;">Linear FEA Parameters</label>
                        <div class="control-group">
                            <label>Analysis Sub-type</label>
                            <select id="feaSubType">
                                <option value="static" selected>Static</option>
                                <option value="buckling">Buckling</option>
                                <option value="shear">Shear</option>
                            </select>
                            <small style="display: block; color: #666; margin-top: 0.25rem;">Select the type of linear analysis to perform</small>
                        </div>
                        <!-- Static-specific parameters -->
                        <div id="feaStaticParamsGroup" class="control-group">
                            <label style="font-weight: 600; font-size: 0.8rem; display: block; margin-bottom: 0.5rem;">Static Analysis Settings</label>
                            <div class="control-group">
                                <label>Output Requests</label>
                                <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                                    <label style="font-weight: normal; font-size: 0.8rem;"><input type="checkbox" id="feaOutputStress" checked> Von Mises Stress</label>
                                    <label style="font-weight: normal; font-size: 0.8rem;"><input type="checkbox" id="feaOutputDisplacement" checked> Displacement</label>
                                    <label style="font-weight: normal; font-size: 0.8rem;"><input type="checkbox" id="feaOutputStrain" checked> Strain Energy</label>
                                </div>
                            </div>
                        </div>
                        <!-- Buckling-specific parameters for linear FEA -->
                        <div id="feaBucklingParamsGroup" class="control-group" style="display: none;">
                            <label style="font-weight: 600; font-size: 0.8rem; display: block; margin-bottom: 0.5rem;">Buckling Parameters</label>
                            <div class="control-group">
                                <label>Number of Buckling Modes</label>
                                <input type="number" id="feaBucklingModes" value="3" min="1" max="10" step="1">
                                <small style="display: block; color: #666; margin-top: 0.25rem;">Number of eigenvalue buckling modes to extract</small>
                            </div>
                            <div class="control-group">
                                <label>Geometric Imperfection Scale</label>
                                <input type="number" id="feaBucklingImperfection" value="0.01" min="0" max="1" step="0.001">
                                <small style="display: block; color: #666; margin-top: 0.25rem;">Magnitude of initial geometric imperfection (fraction of model size)</small>
                            </div>
                        </div>
                        <!-- Shear-specific parameters for linear FEA -->
                        <div id="feaShearParamsGroup" class="control-group" style="display: none;">
                            <label style="font-weight: 600; font-size: 0.8rem; display: block; margin-bottom: 0.5rem;">Shear Analysis Settings</label>
                            <div class="control-group">
                                <label>
                                    <input type="checkbox" id="feaShearOutputShearStress" checked>
                                    Output Shear Stress Components
                                </label>
                            </div>
                        </div>
                    </div>
                    <!-- Nonlinear FEA parameters: shown only for nonlinear -->
                    <div id="nonlinearParamsGroup" class="control-group" style="margin-top: 1rem; display: none;">
                        <label style="font-weight: 600; font-size: 0.875rem; display: block; margin-bottom: 0.5rem;">Nonlinear FEA Parameters</label>
                        <div class="control-group">
                            <label>Analysis Type</label>
                            <select id="nonlinearAnalysisType">
                                <option value="large-deformation" selected>Large Deformation (default)</option>
                                <option value="buckling">Buckling Analysis</option>
                                <option value="plastic-deformation">Plastic Deformation</option>
                                <option value="fracture">Fracture / Tearing</option>
                                <option value="shear">Shear Analysis</option>
                            </select>
                            <small style="display: block; color: #666; margin-top: 0.25rem;">Select the type of nonlinear analysis to perform</small>
                        </div>
                        <div class="control-group">
                            <label>Load Steps</label>
                            <input type="number" id="nonlinearLoadSteps" value="10" min="1" max="100" step="1">
                            <small style="display: block; color: #666; margin-top: 0.25rem;">Number of incremental load steps (more = more stable, slower)</small>
                        </div>
                        <div class="control-group">
                            <label>Max Newton Iterations (per step)</label>
                            <input type="number" id="nonlinearMaxNewtonIter" value="20" min="1" max="100" step="1">
                        </div>
                        <div class="control-group">
                            <label>Convergence Tolerance</label>
                            <input type="number" id="nonlinearTolerance" value="1e-6" min="1e-12" max="1e-2" step="1e-6">
                        </div>
                        <!-- Fracture-specific parameters (shown only for fracture analysis) -->
                        <div id="fractureParamsGroup" class="control-group" style="display: none;">
                            <label style="font-weight: 600; font-size: 0.8rem; display: block; margin-bottom: 0.5rem;">Fracture Parameters</label>
                            <div class="control-group">
                                <label>Fracture Method</label>
                                <select id="fractureMethod">
                                    <option value="phase-field" selected>Phase-Field Fracture</option>
                                    <option value="cohesive-zone">Cohesive Zone Model (CZM)</option>
                                    <option value="element-erosion">Element Erosion</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label>Critical Energy Release Rate (G_c)</label>
                                <input type="number" id="fractureToughness" value="2700" min="0" step="100">
                                <small style="display: block; color: #666; margin-top: 0.25rem;">J/m¬≤ ‚Äî resistance to crack growth</small>
                            </div>
                            <div class="control-group">
                                <label>Fracture Length Scale</label>
                                <input type="number" id="fractureLengthScale" value="0.01" min="0.001" max="1" step="0.001">
                                <small style="display: block; color: #666; margin-top: 0.25rem;">Phase-field regularization width</small>
                            </div>
                        </div>
                        <!-- Buckling-specific parameters -->
                        <div id="bucklingParamsGroup" class="control-group" style="display: none;">
                            <label style="font-weight: 600; font-size: 0.8rem; display: block; margin-bottom: 0.5rem;">Buckling Parameters</label>
                            <div class="control-group">
                                <label>Number of Buckling Modes</label>
                                <input type="number" id="bucklingModes" value="3" min="1" max="10" step="1">
                                <small style="display: block; color: #666; margin-top: 0.25rem;">Number of eigenvalue buckling modes to extract</small>
                            </div>
                            <div class="control-group">
                                <label>Geometric Imperfection Scale</label>
                                <input type="number" id="bucklingImperfection" value="0.01" min="0" max="1" step="0.001">
                                <small style="display: block; color: #666; margin-top: 0.25rem;">Magnitude of initial geometric imperfection (fraction of model size)</small>
                            </div>
                        </div>
                        <!-- Plastic deformation specific parameters -->
                        <div id="plasticParamsGroup" class="control-group" style="display: none;">
                            <label style="font-weight: 600; font-size: 0.8rem; display: block; margin-bottom: 0.5rem;">Plasticity Parameters</label>
                            <div class="control-group">
                                <label>Hardening Modulus (MPa)</label>
                                <input type="number" id="hardeningModulus" value="1000" min="0" step="100">
                                <small style="display: block; color: #666; margin-top: 0.25rem;">Post-yield tangent modulus for isotropic hardening</small>
                            </div>
                        </div>
                    </div>
                    <div class="transform-controls hidden" id="transformControls">
                        <div class="control-group">
                            <label>Scale</label>
                            <input type="number" id="modelScale" value="1" min="0.01" max="1000" step="0.1">
                        </div>
                        <div class="control-group">
                            <label>Rotate X (¬∞)</label>
                            <input type="number" id="rotateX" value="0" min="-360" max="360" step="15">
                        </div>
                        <div class="control-group">
                            <label>Rotate Y (¬∞)</label>
                            <input type="number" id="rotateY" value="0" min="-360" max="360" step="15">
                        </div>
                        <div class="control-group">
                            <label>Rotate Z (¬∞)</label>
                            <input type="number" id="rotateZ" value="0" min="-360" max="360" step="15">
                        </div>
                        <button id="applyTransform" class="btn-secondary">Apply Transform</button>
                    </div>
                </div>
            </div>

            <!-- Step 4: Material & Grain -->
            <div class="step" id="step4" data-step="4" disabled>
                <div class="step-header">
                    <span class="step-number">4</span>
                    <h2>Material & Grain Size</h2>
                </div>
                <div class="step-content">
                    <div class="control-group">
                        <label>Material</label>
                        <select id="materialSelect">
                            <option value="custom">Custom</option>
                            <optgroup label="Rubber-like">
                                <option value="natural-rubber">Natural Rubber</option>
                                <option value="silicone">Silicone</option>
                                <option value="neoprene">Neoprene</option>
                                <option value="epdm">EPDM Rubber</option>
                            </optgroup>
                            <optgroup label="Hard Plastics">
                                <option value="abs" selected>ABS</option>
                                <option value="polycarbonate">Polycarbonate</option>
                                <option value="nylon">Nylon (PA6)</option>
                                <option value="pla">PLA</option>
                                <option value="peek">PEEK</option>
                            </optgroup>
                            <optgroup label="Metals">
                                <option value="aluminum">Aluminum</option>
                                <option value="steel">Steel (Structural)</option>
                                <option value="stainless-steel">Stainless Steel</option>
                                <option value="titanium">Titanium (Ti-6Al-4V)</option>
                                <option value="copper">Copper</option>
                                <option value="brass">Brass</option>
                                <option value="cast-iron">Cast Iron</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Young's Modulus (GPa)</label>
                        <input type="number" id="youngsModulus" value="2.3" min="0.001" step="0.1">
                    </div>
                    <div class="control-group">
                        <label>Poisson's Ratio</label>
                        <input type="number" id="poissonsRatio" value="0.35" min="0.01" max="0.49" step="0.01">
                    </div>
                    <div class="control-group">
                        <label>Yield Strength (MPa)</label>
                        <input type="number" id="yieldStrength" value="40" min="0" step="1">
                        <small style="display: block; color: #666; margin-top: 0.25rem;">Stress threshold for elastic‚Üíplastic transition. 0 = disabled.</small>
                    </div>
                    <div class="control-group">
                        <label>Grain / Voxel Size (mm)</label>
                        <div class="slider-with-input">
                            <input type="range" id="voxelSize" min="0.1" max="10" step="0.1" value="5">
                            <input type="number" id="voxelSizeInput" min="0.1" max="10" step="0.1" value="5">
                            <span>mm</span>
                        </div>
                        <small style="display: block; color: #666; margin-top: 0.25rem;">Smaller values = finer mesh, more elements, longer solve time</small>
                    </div>
                </div>
            </div>

            <!-- Step 5: Manufacturing -->
            <div class="step" id="step5" data-step="5" disabled>
                <div class="step-header">
                    <span class="step-number">5</span>
                    <h2>Manufacturing Method</h2>
                </div>
                <div class="step-content">
                    <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 1rem;">Select a manufacturing method to auto-configure constraints, or skip to use defaults.</p>
                    <div class="manufacturing-options">
                        <div class="manufacturing-card" data-method="3d-print">
                            <span class="manufacturing-icon">üñ®</span>
                            <strong>3D Printed</strong>
                            <small>FDM/SLA ‚Äî allows overhangs up to 45¬∞, prevents internal voids</small>
                        </div>
                        <div class="manufacturing-card" data-method="cnc">
                            <span class="manufacturing-icon">‚öô</span>
                            <strong>CNC Milled</strong>
                            <small>No overhangs (90¬∞), tool radius constraints, max depth limits</small>
                        </div>
                        <div class="manufacturing-card" data-method="injection">
                            <span class="manufacturing-icon">üè≠</span>
                            <strong>Injection Molded</strong>
                            <small>Mold-friendly geometry, 88¬∞ draft, no internal voids</small>
                        </div>
                        <div class="manufacturing-card" data-method="none">
                            <span class="manufacturing-icon">üîß</span>
                            <strong>No Constraint</strong>
                            <small>Skip manufacturing constraints ‚Äî optimize for pure structural performance</small>
                        </div>
                    </div>
                    <div class="sub-panel collapsed" id="manufacturingPanel" style="margin-top: 1rem;">
                        <div class="sub-panel-header" data-toggle="manufacturingPanel">
                            <span>üè≠ Advanced Manufacturing Settings</span>
                            <span class="sub-panel-toggle">‚ñº</span>
                        </div>
                        <div class="sub-panel-body">
                            <div class="control-group">
                                <label>
                                    <input type="checkbox" id="constrainToSolid">
                                    Constrain to initial solid space
                                </label>
                                <small style="display: block; color: #666; margin-top: 0.25rem;">Prevent material from appearing outside the original model shape</small>
                            </div>
                            <div class="control-group">
                                <label>
                                    <input type="checkbox" id="preventVoids">
                                    Prevent internal voids
                                </label>
                                <small style="display: block; color: #666; margin-top: 0.25rem;">Fill enclosed air bubbles that are not connected to the boundary</small>
                            </div>
                            <div class="control-group">
                                <label>
                                    <input type="checkbox" id="manufacturingConstraint">
                                    Manufacturing constraint
                                </label>
                                <small style="display: block; color: #666; margin-top: 0.25rem;">Enforce support for overhangs to ensure manufacturability</small>
                            </div>
                            <div class="control-group" id="manufacturingControls" style="display: none;">
                                <label>Overhang Angle (¬∞)</label>
                                <div class="slider-with-input">
                                    <input type="range" id="manufacturingAngle" min="30" max="90" step="1" value="90">
                                    <input type="number" id="manufacturingAngleInput" min="30" max="90" step="1" value="90">
                                    <span>¬∞</span>
                                </div>
                                <small style="display: block; color: #666; margin-top: 0.25rem;">90¬∞ = CNC machining (no overhangs), 88¬∞ = mold tools, lower = more permissive</small>
                                <label style="margin-top: 0.5rem;">Min Pocket Corner Radius</label>
                                <input type="number" id="manufacturingMinRadius" value="0" min="0" max="10" step="0.5">
                                <small style="display: block; color: #666; margin-top: 0.25rem;">Minimum corner radius for pockets (grid units). 0 = no constraint. Matches CNC tool radius.</small>
                                <label style="margin-top: 0.5rem;">Max Depth</label>
                                <input type="number" id="manufacturingMaxDepth" value="0" min="0" max="100" step="1">
                                <small style="display: block; color: #666; margin-top: 0.25rem;">Maximum milling depth from the top surface (grid units). 0 = no limit.</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 6: Solve & Export -->
            <div class="step" id="step6" data-step="6" disabled>
                <div class="step-header">
                    <span class="step-number">6</span>
                    <h2>Solve & Export</h2>
                </div>
                <div class="step-content">
                    <!-- Loads & Constraints -->
                    <div class="control-group hidden" id="templateDefaultsGroup">
                        <label>
                            <input type="checkbox" id="useTemplateDefaults">
                            Use template defaults
                        </label>
                        <small style="display: block; color: #666; margin-top: 0.25rem;">When checked, uses the predefined force and constraint settings from the template. Uncheck to customize.</small>
                    </div>
                    <div class="sub-panel" id="forcesPanel">
                        <div class="sub-panel-header" data-toggle="forcesPanel">
                            <span>‚¨á Forces</span>
                            <span class="sub-panel-toggle">‚ñº</span>
                        </div>
                        <div class="sub-panel-body">
                            <div class="control-group">
                                <label>Force Direction</label>
                                <select id="forceDirection">
                                    <option value="down">Down (-Y)</option>
                                    <option value="up">Up (+Y)</option>
                                    <option value="left">Left (-X)</option>
                                    <option value="right">Right (+X)</option>
                                    <option value="custom">Custom Vector</option>
                                </select>
                            </div>
                            <div id="forceVectorControls" class="control-group">
                                <label>Force Vector (X, Y, Z)</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <input type="number" id="forceVectorX" value="0" step="0.1" style="width: 4rem;">
                                    <input type="number" id="forceVectorY" value="-1" step="0.1" style="width: 4rem;">
                                    <input type="number" id="forceVectorZ" value="0" step="0.1" style="width: 4rem;">
                                </div>
                                <small style="display: block; color: #666; margin-top: 0.25rem;">Custom force direction components</small>
                            </div>
                            <div class="control-group">
                                <label>Force Type</label>
                                <select id="forceType">
                                    <option value="total" selected>Total (distributed over group)</option>
                                    <option value="pressure">Pressure (per face)</option>
                                </select>
                                <small style="display: block; color: #666; margin-top: 0.25rem;">Total: force spread across selected faces. Pressure: force applied per face.</small>
                            </div>
                            <div class="control-group">
                                <label id="forceMagnitudeLabel">Force Magnitude (N)</label>
                                <input type="number" id="forceMagnitude" value="1000" min="1" step="100">
                            </div>
                        </div>
                    </div>

                    <div class="sub-panel" id="constraintsPanel">
                        <div class="sub-panel-header" data-toggle="constraintsPanel">
                            <span>üìå Constraints</span>
                            <span class="sub-panel-toggle">‚ñº</span>
                        </div>
                        <div class="sub-panel-body">
                            <div class="control-group">
                                <label>Constraint DOFs</label>
                                <select id="constraintDOFs">
                                    <option value="all" selected>All (XYZ)</option>
                                    <option value="xy">XY only</option>
                                    <option value="xz">XZ only</option>
                                    <option value="yz">YZ only</option>
                                    <option value="x">X only</option>
                                    <option value="y">Y only</option>
                                    <option value="z">Z only</option>
                                </select>
                            </div>
                            <div id="dofPreview" class="dof-preview">
                                <small><strong>DOF Preview:</strong> <span id="dofPreviewText">Fixed: X ‚úì Y ‚úì Z ‚úì ‚Äî Fully constrained</span></small>
                            </div>
                            <div class="control-group">
                                <label>Constraint Position</label>
                                <select id="constraintPosition">
                                    <option value="left">Left Edge</option>
                                    <option value="right">Right Edge</option>
                                    <option value="bottom">Bottom Edge</option>
                                    <option value="top">Top Edge</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="sub-panel collapsed" id="paintPanel">
                        <div class="sub-panel-header" data-toggle="paintPanel">
                            <span>üñå Paint Tools</span>
                            <span class="sub-panel-toggle">‚ñº</span>
                        </div>
                        <div class="sub-panel-body">
                            <div class="paint-toolbar">
                                <button id="paintConstraint" class="btn-secondary" title="Click faces on the model to mark them as fixed constraints">üñå Paint Constraints</button>
                                <button id="paintForce" class="btn-secondary" title="Click faces on the model to apply forces (arrows show direction)">üñå Paint Forces</button>
                                <button id="clearPaint" class="btn-secondary" title="Exit paint mode">‚úã Stop Painting</button>
                                <div class="control-group" style="margin-top: 0.5rem;">
                                    <label>
                                        <input type="checkbox" id="useAngleSelection">
                                        Angle-based surface selection
                                    </label>
                                    <small style="display: block; color: #666; margin-top: 0.25rem;">Click a face to select connected surfaces within angle tolerance</small>
                                </div>
                                <div id="angleToleranceControls" class="control-group" style="margin-top: 0.5rem; display: none;">
                                    <label>Angle Tolerance (¬∞)</label>
                                    <div class="slider-with-input">
                                        <input type="range" id="angleTolerance" min="1" max="180" step="1" value="45">
                                        <input type="number" id="angleToleranceInput" min="1" max="180" step="1" value="45">
                                        <span>¬∞</span>
                                    </div>
                                </div>
                                <div class="control-group" style="margin-top: 0.5rem;">
                                    <label>Brush Size</label>
                                    <input type="range" id="brushSize" min="1" max="10" step="1" value="1">
                                    <span id="brushSizeValue">1</span>
                                </div>
                            </div>
                            <div class="groups-toolbar" style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border-color);">
                                <label style="font-weight: 600; font-size: 0.875rem;">Selection Groups</label>
                                <small style="display: block; color: #666; margin-bottom: 0.5rem;">Create a group, then select its type and paint faces</small>
                                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    <button id="addGroup" class="btn-secondary" style="font-size: 0.75rem;">+ Add Group</button>
                                </div>
                                <div id="selectionGroupsList" style="margin-top: 0.5rem;"></div>
                            </div>
                            <div class="groups-toolbar" style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border-color);">
                                <label style="font-weight: 600; font-size: 0.875rem;">üî∑ Shape Selection</label>
                                <small style="display: block; color: #666; margin-bottom: 0.5rem;">Place 3D shapes to select faces by intersection</small>
                                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    <button id="addShapeCube" class="btn-secondary" style="font-size: 0.75rem;">+ Cube</button>
                                    <button id="addShapeCylinder" class="btn-secondary" style="font-size: 0.75rem;">+ Cylinder</button>
                                    <button id="addShapeBall" class="btn-secondary" style="font-size: 0.75rem;">+ Ball</button>
                                </div>
                                <div id="shapeSelectionList" style="margin-top: 0.5rem;"></div>
                                <button id="applyAllShapesToGroup" class="btn-secondary" style="font-size: 0.75rem; width: 100%; margin-top: 0.5rem; display: none;">Apply All Shapes to Active Group</button>
                            </div>
                        </div>
                    </div>

                    <!-- Solver Parameters -->
                    <div class="sub-panel collapsed" id="solverParamsPanel">
                        <div class="sub-panel-header" data-toggle="solverParamsPanel">
                            <span>‚ö° Solver Parameters</span>
                            <span class="sub-panel-toggle">‚ñº</span>
                        </div>
                        <div class="sub-panel-body">
                            <div class="control-group">
                                <label>Volume Fraction (target material %)</label>
                                <input type="range" id="volumeFraction" min="0.1" max="0.9" step="0.05" value="0.7">
                                <span id="volumeFractionValue">70%</span>
                            </div>
                            <div class="control-group">
                                <label>Max Iterations</label>
                                <input type="number" id="maxIterations" value="30" min="10" max="500" step="10">
                            </div>
                            <div class="control-group">
                                <label>Penalty Factor</label>
                                <input type="number" id="penaltyFactor" value="20" min="1" max="30" step="0.5">
                            </div>
                            <div class="control-group">
                                <label>Filter Radius</label>
                                <input type="number" id="filterRadius" value="0.9" min="0.1" max="5" step="0.1">
                            </div>
                            <div class="control-group">
                                <label>FEA Solver Backend</label>
                                <select id="feaSolverBackend">
                                    <option value="auto" selected>Auto (best available)</option>
                                    <option value="webgpu">WebGPU (GPU-resident CG)</option>
                                    <option value="wasm">WASM (native speed)</option>
                                    <option value="js">JavaScript (fallback)</option>
                                </select>
                                <small id="feaSolverStatus" style="display: block; color: #666; margin-top: 0.25rem;">Detecting available backends...</small>
                            </div>
                            <div class="control-group">
                                <label>Volumetric Stress Output</label>
                                <select id="volumetricOutputMode">
                                    <option value="off">Disabled</option>
                                    <option value="on-stop" selected>On pause/finish</option>
                                    <option value="every-iteration">Every iteration + pause/finish</option>
                                </select>
                                <small style="display: block; color: #666; margin-top: 0.25rem;">Controls when full volumetric stress data is streamed from the solver.</small>
                            </div>
                            <div class="control-group">
                                <button id="extractVolumetricStress" type="button" class="btn btn-secondary">Extract Last Volumetric Stress</button>
                                <small style="display: block; color: #666; margin-top: 0.25rem;">Use on demand when per-iteration streaming is disabled.</small>
                            </div>
                        </div>
                    </div>

                    <!-- Genetic Algorithm Parameters -->
                    <div class="sub-panel collapsed" id="geneticPanel" style="display: none;">
                        <div class="sub-panel-header" data-toggle="geneticPanel">
                            <span>üß¨ Genetic Algorithm Parameters</span>
                            <span class="sub-panel-toggle">‚ñº</span>
                        </div>
                        <div class="sub-panel-body">
                            <div class="control-group">
                                <label>Population Size</label>
                                <input type="number" id="populationSize" value="20" min="4" max="200" step="2">
                                <small style="display: block; color: #666; margin-top: 0.25rem;">Number of individuals per generation</small>
                            </div>
                            <div class="control-group">
                                <label>Elite Count</label>
                                <input type="number" id="eliteCount" value="2" min="1" max="20" step="1">
                                <small style="display: block; color: #666; margin-top: 0.25rem;">Top individuals kept unchanged</small>
                            </div>
                            <div class="control-group">
                                <label>Mutation Rate</label>
                                <input type="number" id="mutationRate" value="0.02" min="0.001" max="0.5" step="0.005">
                                <small style="display: block; color: #666; margin-top: 0.25rem;">Per-element mutation probability</small>
                            </div>
                            <div class="control-group">
                                <label>Crossover Rate</label>
                                <input type="number" id="crossoverRate" value="0.8" min="0.1" max="1" step="0.05">
                                <small style="display: block; color: #666; margin-top: 0.25rem;">Probability of crossover vs clone</small>
                            </div>
                            <div class="control-group">
                                <label>Tournament Size</label>
                                <input type="number" id="tournamentSize" value="3" min="2" max="10" step="1">
                                <small style="display: block; color: #666; margin-top: 0.25rem;">Tournament selection size</small>
                            </div>
                            <div class="control-group">
                                <label>Volume Penalty</label>
                                <input type="number" id="volumePenalty" value="2.0" min="0.1" max="10" step="0.1">
                                <small style="display: block; color: #666; margin-top: 0.25rem;">Weight for volume constraint penalty</small>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Parameters Sub-Panel -->
                    <div class="sub-panel collapsed" id="advancedPanel">
                        <div class="sub-panel-header" data-toggle="advancedPanel">
                            <span>‚öô Advanced Parameters</span>
                            <span class="sub-panel-toggle">‚ñº</span>
                        </div>
                        <div class="sub-panel-body">
                            <div class="control-group">
                                <label>Min Cross-Section (elements)</label>
                                <input type="number" id="minCrossSection" value="0" min="0" max="5" step="0.5">
                                <small style="display: block; color: #666; margin-top: 0.25rem;">0 = disabled, enforces minimum feature size</small>
                            </div>
                            <div class="control-group">
                                <label>Penalty Start</label>
                                <input type="number" id="penalStart" value="1.5" min="1" max="10" step="0.1">
                                <small style="display: block; color: #666; margin-top: 0.25rem;">Initial penalty value for continuation ramp</small>
                            </div>
                            <div class="control-group">
                                <label>Continuation Iterations</label>
                                <input type="number" id="continuationIters" value="20" min="1" max="200" step="1">
                                <small style="display: block; color: #666; margin-top: 0.25rem;">Number of iterations to ramp penalty from start to target</small>
                            </div>
                            <div class="control-group">
                                <label>
                                    <input type="checkbox" id="useProjection" checked>
                                    Heaviside Projection
                                </label>
                                <small style="display: block; color: #666; margin-top: 0.25rem;">Apply Heaviside projection for crisp 0/1 designs</small>
                            </div>
                            <div class="control-group" id="projectionControls">
                                <label>Beta Max</label>
                                <input type="number" id="betaMax" value="64" min="1" max="256" step="1">
                                <small style="display: block; color: #666; margin-top: 0.25rem;">Maximum projection sharpness (higher = more binary)</small>
                            </div>
                            <div class="control-group" id="projectionControls2">
                                <label>Beta Interval</label>
                                <input type="number" id="betaInterval" value="5" min="1" max="50" step="1">
                                <small style="display: block; color: #666; margin-top: 0.25rem;">Double beta every N iterations</small>
                            </div>
                            <hr style="border: none; border-top: 1px solid var(--border-color); margin: 1rem 0;">
                            <div class="control-group">
                                <label>
                                    <input type="checkbox" id="useAMR">
                                    Adaptive Mesh Refinement (AMR)
                                </label>
                                <small style="display: block; color: #666; margin-top: 0.25rem;">Dynamically refine high-stress areas</small>
                            </div>
                            <div class="control-group" id="amrControls">
                                <label>Min Granule Size</label>
                                <input type="number" id="minGranuleSize" value="0.02" min="0.01" max="2" step="0.01">
                                <small style="display: block; color: #666; margin-top: 0.25rem;">Smallest voxel size in high-stress areas</small>
                            </div>
                            <div class="control-group" id="amrControls2">
                                <label>Max Granule Size</label>
                                <input type="number" id="maxGranuleSize" value="2" min="1" max="8" step="0.5">
                                <small style="display: block; color: #666; margin-top: 0.25rem;">Largest voxel size in low-stress areas</small>
                            </div>
                            <div class="control-group" id="amrControls3">
                                <label>AMR Recalculation Interval</label>
                                <input type="number" id="amrInterval" value="3" min="1" max="50" step="1">
                                <small style="display: block; color: #666; margin-top: 0.25rem;">Recalculate dynamic grain sizes every N iterations</small>
                            </div>
                        </div>
                    </div>

                    <button id="runOptimization" class="btn-primary">Run Optimization</button>
                    <!-- label is updated dynamically based on solution type -->
                    <button id="pauseOptimization" class="btn-secondary hidden">Pause</button>
                    <button id="cancelOptimization" class="btn-cancel hidden">Cancel</button>

                    <div id="progressContainer" class="progress-container hidden">
                        <div class="progress-bar">
                            <div id="progressFill" class="progress-fill"></div>
                        </div>
                        <p id="progressText">Iteration 0 / 100</p>
                        <p id="complianceText"></p>
                    </div>

                    <!-- Export (shown after optimization completes) -->
                    <div id="exportSection" class="export-controls hidden" style="margin-top: 1rem;">
                        <div class="export-info">
                            <p id="optimizationResults"></p>
                        </div>
                        <button id="resetSolution" class="btn-secondary">Reset Solution</button>
                        <button id="downloadSTL" class="btn-primary">Download STL</button>
                        <button id="downloadJSON" class="btn-secondary">Download JSON Data</button>
                        <button id="exportSetup" class="btn-secondary">Export Setup</button>
                        <button id="importSetup" class="btn-secondary">Import Setup</button>
                    </div>

                    <button id="showBenchmarkHistory" class="btn-secondary hidden" style="margin-top: 0.5rem;">üìä Benchmark History</button>

                    <button id="resetApp" class="btn-secondary" style="margin-top: 1rem;">Start Over</button>
                </div>
            </div>
        </div>

        <!-- 3D Viewer -->
        <div class="viewer-container">
            <div id="viewer3D"></div>
            <div class="viewer-controls">
                <button id="toggleViewMode" class="btn-icon" title="Switch to Voxel View">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="4" y="4" width="7" height="7"></rect>
                        <rect x="13" y="4" width="7" height="7"></rect>
                        <rect x="4" y="13" width="7" height="7"></rect>
                        <rect x="13" y="13" width="7" height="7"></rect>
                    </svg>
                </button>
                <button id="toggleMeshVisibility" class="btn-icon" title="Hide Mesh">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                </button>
                <button id="toggleWireframe" class="btn-icon" title="Toggle Wireframe">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18"></rect>
                    </svg>
                </button>
                <button id="toggleSection" class="btn-icon" title="Toggle Section View (Alt+Drag: rotate, Alt+Scroll: move)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="1"></rect>
                        <line x1="12" y1="1" x2="12" y2="23"></line>
                    </svg>
                </button>
                <button id="toggleReference" class="btn-icon" title="Toggle Reference Model">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                    </svg>
                </button>
                <button id="resetCamera" class="btn-icon" title="Reset Camera">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                        <path d="M21 3v5h-5"></path>
                        <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                        <path d="M3 21v-5h5"></path>
                    </svg>
                </button>
            </div>
            <div class="viewer-params-row">
                <div id="densityThresholdContainer" class="section-slider-container">
                    <label class="section-slider-title">Density Threshold</label>
                    <div class="section-slider-group">
                        <label>Min</label>
                        <input type="range" id="densityThresholdSlider" min="0" max="1" step="0.01" value="0.3">
                        <span id="densityThresholdValue">0.30</span>
                    </div>
                </div>
                <div id="displacementContainer" class="section-slider-container hidden">
                    <label class="section-slider-title">‚Üî Deformed Shape</label>
                    <div class="section-slider-group">
                        <label>
                            <input type="checkbox" id="toggleDisplacement">
                            Show
                        </label>
                    </div>
                    <div class="section-slider-group">
                        <label>Scale</label>
                        <input type="range" id="displacementScaleSlider" min="1" max="200" step="1" value="1">
                        <span id="displacementScaleValue">1√ó</span>
                    </div>
                </div>
                <div id="loadStepContainer" class="section-slider-container hidden">
                    <label class="section-slider-title">‚è± Load Step</label>
                    <div class="section-slider-group">
                        <label>Step</label>
                        <input type="range" id="loadStepSlider" min="1" max="10" step="1" value="10">
                        <span id="loadStepValue">10/10</span>
                    </div>
                    <div class="section-slider-group">
                        <label>Load</label>
                        <span id="loadStepFraction" style="font-size: 0.75rem;">100%</span>
                    </div>
                    <div id="loadStepStatus" style="font-size: 0.7rem; text-align: center; margin-top: 0.25rem;"></div>
                </div>
                <div id="resultDisplayContainer" class="section-slider-container hidden">
                    <label class="section-slider-title">üé® Result Display</label>
                    <div class="section-slider-group">
                        <label>Color Mode</label>
                        <select id="resultColorMode" style="flex: 1; font-size: 0.75rem; padding: 0.15rem 0.25rem;">
                            <option value="stress" selected>Von Mises Stress</option>
                            <option value="strain">Strain Energy</option>
                            <option value="displacement">Displacement Magnitude</option>
                            <option value="density">Material Density</option>
                            <option value="plasticStrain">Plastic Strain</option>
                            <option value="triaxiality">Stress Triaxiality</option>
                            <option value="damage">Damage / Phase Field</option>
                        </select>
                    </div>
                    <div class="section-slider-group">
                        <label>
                            <input type="checkbox" id="resultAutoRange" checked>
                            Auto Range
                        </label>
                    </div>
                    <div class="section-slider-group">
                        <label>
                            <input type="checkbox" id="resultShowDeformed">
                            Show Deformed Shape
                        </label>
                    </div>
                    <div class="section-slider-group">
                        <label>Iso-surface</label>
                        <input type="range" id="resultIsoSurface" min="0" max="100" step="1" value="50" style="flex: 1;">
                        <span id="resultIsoSurfaceValue" style="font-size: 0.75rem;">50%</span>
                    </div>
                    <div class="section-slider-group">
                        <label>
                            <input type="checkbox" id="resultClipPlane">
                            Clip Plane
                        </label>
                    </div>
                </div>
                <div id="sectionSliderContainer" class="section-slider-container hidden">
                    <label class="section-slider-title">‚úÇ Section Plane</label>
                    <div class="section-slider-group">
                        <label>Azimuth</label>
                        <input type="range" id="sectionAzimuth" min="0" max="360" step="1" value="90">
                        <span id="sectionAzimuthValue">90¬∞</span>
                    </div>
                    <div class="section-slider-group">
                        <label>Elevation</label>
                        <input type="range" id="sectionElevation" min="-90" max="90" step="1" value="0">
                        <span id="sectionElevationValue">0¬∞</span>
                    </div>
                    <div class="section-slider-group">
                        <label>Offset</label>
                        <input type="range" id="sectionOffsetSlider" min="0" max="100" step="0.1" value="50">
                        <span id="sectionOffsetValue">50%</span>
                    </div>
                </div>
            </div>
            <div class="viewer-params-nav">
                <button class="viewer-params-nav-btn active" data-target="densityThresholdContainer">Density</button>
                <button class="viewer-params-nav-btn hidden-tab" data-target="displacementContainer">Displacement</button>
                <button class="viewer-params-nav-btn hidden-tab" data-target="loadStepContainer">Load Step</button>
                <button class="viewer-params-nav-btn hidden-tab" data-target="resultDisplayContainer">Result</button>
                <button class="viewer-params-nav-btn hidden-tab" data-target="sectionSliderContainer">Section</button>
            </div>
        </div>
    </div>

    <!-- Mobile panel toggle logic -->
    <script>
        (function() {
            const btn = document.getElementById('mobileTogglePanel');
            const icon = document.getElementById('mobileToggleIcon');
            const workflow = document.querySelector('.workflow');
            const container = document.querySelector('.container');
            if (!btn || !icon || !workflow || !container) return;
            let minimized = false;

            function isMobile() {
                return window.matchMedia('(max-width: 1024px)').matches;
            }

            btn.addEventListener('click', function() {
                if (!isMobile()) return;
                minimized = !minimized;
                container.classList.toggle('workflow-minimized', minimized);
                workflow.classList.toggle('minimized', minimized);
                icon.setAttribute('points', minimized ? '6 9 12 15 18 9' : '18 15 12 9 6 15');
                btn.title = minimized ? 'Expand Settings' : 'Minimize Settings';
                window.dispatchEvent(new Event('resize'));
            });

            // Mobile 3D viewer toggle logic
            var viewerBtn = document.getElementById('mobileToggleViewer');
            var viewerContainer = document.querySelector('.viewer-container');
            var viewerMinimized = false;

            if (viewerBtn && viewerContainer) {

                viewerBtn.addEventListener('click', function() {
                    if (!isMobile()) return;
                    viewerMinimized = !viewerMinimized;
                    viewerContainer.classList.toggle('viewer-minimized', viewerMinimized);
                    viewerBtn.title = viewerMinimized ? 'Show 3D Viewer' : 'Hide 3D Viewer';
                    window.dispatchEvent(new Event('resize'));
                });

                // Reset viewer state on desktop resize
                window.addEventListener('resize', function() {
                    if (!isMobile()) {
                        viewerContainer.classList.remove('viewer-minimized');
                    } else if (viewerMinimized) {
                        viewerContainer.classList.add('viewer-minimized');
                    }
                });
            }

            // Params tab navigation for mobile carousel
            const navBtns = document.querySelectorAll('.viewer-params-nav-btn');
            const paramsRow = document.querySelector('.viewer-params-row');
            const paramContainers = paramsRow ? paramsRow.querySelectorAll('.section-slider-container') : [];

            function updateNavTabs() {
                navBtns.forEach(function(btn) {
                    var target = document.getElementById(btn.dataset.target);
                    if (!target) return;
                    var isHidden = target.classList.contains('hidden');
                    btn.classList.toggle('hidden-tab', isHidden);
                });
                // If active tab is now hidden, switch to first visible
                var activeBtn = document.querySelector('.viewer-params-nav-btn.active');
                if (activeBtn && activeBtn.classList.contains('hidden-tab')) {
                    var firstVisible = document.querySelector('.viewer-params-nav-btn:not(.hidden-tab)');
                    if (firstVisible) firstVisible.click();
                }
            }

            function showTab(targetId) {
                if (!isMobile()) return;
                paramContainers.forEach(function(c) {
                    if (c.classList.contains('hidden')) return;
                    c.style.display = (c.id === targetId) ? '' : 'none';
                });
                navBtns.forEach(function(b) {
                    b.classList.toggle('active', b.dataset.target === targetId);
                });
            }

            navBtns.forEach(function(b) {
                b.addEventListener('click', function() {
                    showTab(b.dataset.target);
                });
            });

            // Observe container class changes to sync tab visibility
            var observer = new MutationObserver(function() {
                updateNavTabs();
                // On desktop, reset inline display styles
                if (!isMobile()) {
                    paramContainers.forEach(function(c) { c.style.display = ''; });
                }
            });
            paramContainers.forEach(function(c) {
                observer.observe(c, { attributes: true, attributeFilter: ['class'] });
            });

            // Handle resize between mobile/desktop
            window.addEventListener('resize', function() {
                if (!isMobile()) {
                    paramContainers.forEach(function(c) { c.style.display = ''; });
                } else {
                    var activeBtn = document.querySelector('.viewer-params-nav-btn.active:not(.hidden-tab)');
                    if (activeBtn) showTab(activeBtn.dataset.target);
                }
            });

            // Initial sync
            updateNavTabs();
            if (isMobile()) {
                var activeBtn = document.querySelector('.viewer-params-nav-btn.active:not(.hidden-tab)');
                if (activeBtn) showTab(activeBtn.dataset.target);
            }
        })();
    </script>

    <!-- Benchmark History Modal -->
    <div id="benchmarkModal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 720px;">
            <div class="modal-header">
                <h3>üìä Benchmark History</h3>
                <button class="modal-close" id="closeBenchmarkModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="benchmarkResults"></div>
            </div>
        </div>
    </div>

    <!-- Import application modules -->
    <script type="module" src="js/main.js"></script>
</body>
</html>
