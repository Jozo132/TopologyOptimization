<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topology Optimization</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Topology <span>Optimization</span></h1>
            <p class="subtitle">Import â†’ Assign â†’ Solve â†’ Export</p>
        </header>

        <div class="workflow">
            <!-- Step 1: Import -->
            <div class="step" id="step1" data-step="1">
                <div class="step-header">
                    <span class="step-number">1</span>
                    <h2>Import Model</h2>
                </div>
                <div class="step-content">
                    <div class="upload-area" id="uploadArea">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <p>Drop STL file here or click to browse</p>
                        <input type="file" id="fileInput" accept=".stl" hidden>
                    </div>
                    <div class="control-group" style="margin-top: 1rem;">
                        <label>Voxel Size (mm)</label>
                        <div class="slider-with-input">
                            <input type="range" id="voxelSize" min="0.1" max="10" step="0.1" value="2">
                            <input type="number" id="voxelSizeInput" min="0.1" max="10" step="0.1" value="2">
                            <span>mm</span>
                        </div>
                    </div>
                    <div class="transform-controls hidden" id="transformControls">
                        <div class="control-group">
                            <label>Scale</label>
                            <input type="number" id="modelScale" value="1" min="0.01" max="1000" step="0.1">
                        </div>
                        <div class="control-group">
                            <label>Rotate X (Â°)</label>
                            <input type="number" id="rotateX" value="0" min="-360" max="360" step="15">
                        </div>
                        <div class="control-group">
                            <label>Rotate Y (Â°)</label>
                            <input type="number" id="rotateY" value="0" min="-360" max="360" step="15">
                        </div>
                        <div class="control-group">
                            <label>Rotate Z (Â°)</label>
                            <input type="number" id="rotateZ" value="0" min="-360" max="360" step="15">
                        </div>
                        <button id="applyTransform" class="btn-secondary">Apply Transform</button>
                    </div>
                    <div class="quick-start">
                        <p>Or start with a template:</p>
                        <button id="useBeamTemplate" class="btn-secondary">Cantilever Beam</button>
                        <button id="useBridgeTemplate" class="btn-secondary">Bridge</button>
                        <button id="useCubeTemplate" class="btn-secondary">Cube Test (3D)</button>
                    </div>
                    <div id="modelInfo" class="model-info hidden"></div>
                </div>
            </div>

            <!-- Step 2: Assign -->
            <div class="step" id="step2" data-step="2" disabled>
                <div class="step-header">
                    <span class="step-number">2</span>
                    <h2>Assign Loads & Constraints</h2>
                </div>
                <div class="step-content">
                    <div class="assignment-controls">
                        <div class="control-group">
                            <label>Material</label>
                            <select id="materialSelect">
                                <option value="custom">Custom</option>
                                <option value="plastic" selected>Plastic (ABS)</option>
                                <option value="aluminum">Aluminum</option>
                                <option value="steel">Steel</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Young's Modulus (GPa)</label>
                            <input type="number" id="youngsModulus" value="2.3" min="0.001" step="0.1">
                        </div>
                        <div class="control-group">
                            <label>Poisson's Ratio</label>
                            <input type="number" id="poissonsRatio" value="0.35" min="0.01" max="0.49" step="0.01">
                        </div>
                        <div class="control-group">
                            <label>Volume Fraction (target material %)</label>
                            <input type="range" id="volumeFraction" min="0.1" max="0.9" step="0.05" value="0.4">
                            <span id="volumeFractionValue">40%</span>
                        </div>
                        <div class="control-group">
                            <label>Force Direction</label>
                            <select id="forceDirection">
                                <option value="down">Down (-Y)</option>
                                <option value="up">Up (+Y)</option>
                                <option value="left">Left (-X)</option>
                                <option value="right">Right (+X)</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Force Magnitude (N)</label>
                            <input type="number" id="forceMagnitude" value="1000" min="1" step="100">
                        </div>
                        <div class="control-group">
                            <label>Constraint Position</label>
                            <select id="constraintPosition">
                                <option value="left">Left Edge</option>
                                <option value="right">Right Edge</option>
                                <option value="bottom">Bottom Edge</option>
                                <option value="top">Top Edge</option>
                            </select>
                        </div>
                        <div class="paint-toolbar">
                            <button id="paintConstraint" class="btn-secondary" title="Click faces on the model to mark them as fixed constraints">ðŸ–Œ Paint Constraints</button>
                            <button id="paintForce" class="btn-secondary" title="Click faces on the model to apply forces (arrows show direction)">ðŸ–Œ Paint Forces</button>
                            <button id="clearPaint" class="btn-secondary" title="Exit paint mode">âœ‹ Stop Painting</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Solve -->
            <div class="step" id="step3" data-step="3" disabled>
                <div class="step-header">
                    <span class="step-number">3</span>
                    <h2>Solve Optimization</h2>
                </div>
                <div class="step-content">
                    <div class="solve-controls">
                        <div class="control-group">
                            <label>Max Iterations</label>
                            <input type="number" id="maxIterations" value="100" min="10" max="500" step="10">
                        </div>
                        <div class="control-group">
                            <label>Penalty Factor</label>
                            <input type="number" id="penaltyFactor" value="3" min="1" max="5" step="0.5">
                        </div>
                        <div class="control-group">
                            <label>Filter Radius</label>
                            <input type="number" id="filterRadius" value="1.5" min="0.5" max="5" step="0.5">
                        </div>
                        <div class="control-group">
                            <label>Min Cross-Section (elements)</label>
                            <input type="number" id="minCrossSection" value="0" min="0" max="5" step="0.5">
                            <small style="display: block; color: #666; margin-top: 0.25rem;">0 = disabled, enforces minimum feature size</small>
                        </div>
                        <div class="control-group">
                            <label>
                                <input type="checkbox" id="constrainToSolid">
                                Constrain to initial solid space
                            </label>
                            <small style="display: block; color: #666; margin-top: 0.25rem;">Prevent material from appearing outside the original model shape</small>
                        </div>
                        <div class="control-group">
                            <label>
                                <input type="checkbox" id="useAMR" checked>
                                Adaptive Mesh Refinement (AMR)
                            </label>
                            <small style="display: block; color: #666; margin-top: 0.25rem;">Dynamically refine high-stress areas</small>
                        </div>
                        <div class="control-group" id="amrControls">
                            <label>Min Granule Size</label>
                            <input type="number" id="minGranuleSize" value="0.5" min="0.25" max="2" step="0.25">
                            <small style="display: block; color: #666; margin-top: 0.25rem;">Smallest voxel size in high-stress areas</small>
                        </div>
                        <div class="control-group" id="amrControls2">
                            <label>Max Granule Size</label>
                            <input type="number" id="maxGranuleSize" value="2" min="1" max="8" step="0.5">
                            <small style="display: block; color: #666; margin-top: 0.25rem;">Largest voxel size in low-stress areas</small>
                        </div>
                        <div class="control-group" id="amrControls3">
                            <label>AMR Recalculation Interval</label>
                            <input type="number" id="amrInterval" value="3" min="1" max="50" step="1">
                            <small style="display: block; color: #666; margin-top: 0.25rem;">Recalculate dynamic grain sizes every N iterations</small>
                        </div>
                        <button id="runOptimization" class="btn-primary">Run Optimization</button>
                        <button id="cancelOptimization" class="btn-cancel hidden">Cancel</button>
                    </div>
                    <div id="progressContainer" class="progress-container hidden">
                        <div class="progress-bar">
                            <div id="progressFill" class="progress-fill"></div>
                        </div>
                        <p id="progressText">Iteration 0 / 100</p>
                        <p id="complianceText"></p>
                    </div>
                    <div id="benchmarkInfo" class="benchmark-info hidden">
                        <h3>ðŸ“Š Benchmark History</h3>
                        <div id="benchmarkResults"></div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Export -->
            <div class="step" id="step4" data-step="4" disabled>
                <div class="step-header">
                    <span class="step-number">4</span>
                    <h2>Export Result</h2>
                </div>
                <div class="step-content">
                    <div class="export-controls">
                        <div class="export-info">
                            <p id="optimizationResults"></p>
                        </div>
                        <button id="downloadSTL" class="btn-primary">Download STL</button>
                        <button id="downloadJSON" class="btn-secondary">Download JSON Data</button>
                        <button id="resetApp" class="btn-secondary">Start Over</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3D Viewer -->
        <div class="viewer-container">
            <div id="viewer3D"></div>
            <div class="viewer-controls">
                <button id="toggleViewMode" class="btn-icon" title="Switch to Voxel View">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="4" y="4" width="7" height="7"></rect>
                        <rect x="13" y="4" width="7" height="7"></rect>
                        <rect x="4" y="13" width="7" height="7"></rect>
                        <rect x="13" y="13" width="7" height="7"></rect>
                    </svg>
                </button>
                <button id="toggleMeshVisibility" class="btn-icon" title="Hide Mesh">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                </button>
                <button id="toggleWireframe" class="btn-icon" title="Toggle Wireframe">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18"></rect>
                    </svg>
                </button>
                <button id="resetCamera" class="btn-icon" title="Reset Camera">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                        <path d="M21 3v5h-5"></path>
                        <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                        <path d="M3 21v-5h5"></path>
                    </svg>
                </button>
            </div>
            <div id="strainSliderContainer" class="strain-slider-container hidden">
                <label class="strain-slider-label">Strain Range</label>
                <div class="strain-slider-track" id="strainSliderTrack">
                    <div class="strain-slider-fill" id="strainSliderFill"></div>
                    <input type="range" class="strain-slider-input strain-slider-min" id="strainMin" min="0" max="1" step="0.01" value="0">
                    <input type="range" class="strain-slider-input strain-slider-max" id="strainMax" min="0" max="1" step="0.01" value="1">
                </div>
                <div class="strain-slider-values">
                    <span id="strainMinValue">0%</span>
                    <span id="strainMaxValue">100%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Import application modules -->
    <script type="module" src="js/main.js"></script>
</body>
</html>
